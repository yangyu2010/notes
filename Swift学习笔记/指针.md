#Swift指针

Swift中也有专门的指针类型，这些都被定性为“Unsafe”(不安全的)，常见的有以下4种类型 

`UnsafePointer<Pointee>` 类似于 `const Pointee *`
`UnsafeMutablePointer<Pointee>` 类似于 `Pointee *`
`UnsafeRawPointer` 类似于 `const void *`
`UnsafeMutableRawPointer` 类似于 `void *`

###示例代码
```
var age = 10

func test1(_ ptr: UnsafePointer<Int>) {
    print("test1", ptr.pointee)
}
func test2(_ ptr: UnsafeMutablePointer<Int>) {
    ptr.pointee = 20
    print("test1", ptr.pointee)
}

test1(&age)
test2(&age)
print(age)
// test1 10
// test1 20
// age 20
```

```
var age = 10

func test3(_ ptr: UnsafeRawPointer) {
    let intValue = ptr.load(as: Int.self)
    print("test3", intValue)
}

func test4(_ ptr: UnsafeMutableRawPointer) {
    let intValue = ptr.load(as: Int.self)
    print("test4", intValue)
    ptr.storeBytes(of: 20, as: Int.self)
}

test3(&age)
test4(&age)
print("age", age)
// test3 10
// test4 10
// age 20
```

![图1](Xnip2022-02-11_17-32-53.jpg)


###应用

```
var arr = NSArray(objects: 11, 22, 33, 44)
arr.enumerateObjects { <ObjectType>, <UInt>, <UnsafeMutablePointer<ObjCBool>> in
    <code>
}
```


###获得指向某个变量的指针

```

var age = 10

var ptr0 = withUnsafePointer(to: &age) { ptr in

}

var ptr1 = withUnsafePointer(to: &age) { ptr in
    return ptr
}

var ptr2 = withUnsafePointer(to: &age) { $0 }
var ptr3 = withUnsafeMutablePointer(to: &age) { $0 }

print(ptr0)
print(ptr1)
print(ptr1.pointee)

ptr3.pointee = 20
print(ptr2.pointee)
print(age)


// ()
// 0x000000010000c210
// 10
// 20
// 20
```

```
接收两个参数
第一个参数: value: inout T
第二个参数: body: (UnsafePointer<T>) throws -> Result
是个闭包, 参数是UnsafePointer类型, 返回值是Result

返回值是Result
也就是说接收一个闭包, 闭包的返回值, 就是整个函数的返回值(Result)

@inlinable public func withUnsafePointer<T, Result>(to value: inout T, _ body: (UnsafePointer<T>) throws -> Result) rethrows -> Result
```


```
var age = 10

var ptr4 = withUnsafePointer(to: &age) { pointer in
    UnsafeMutableRawPointer(mutating: pointer)
}

var ptr5 = withUnsafePointer(to: &age) { pointer in
    UnsafeRawPointer(pointer)
}

let int = ptr5.load(as: Int.self)
print(int)

ptr4.storeBytes(of: 33, as: Int.self)
print(age)
```


###获得指向堆空间实例的指针
```
class Person {
    var age = 10
}

var p = Person()
var ptr = withUnsafePointer(to: &p) { UnsafeRawPointer($0) }
var address = ptr.load(as: UInt.self)
let p2 = UnsafeRawPointer(bitPattern: address)

print("p指针的地址", UnsafeRawPointer(&p))
print("ptr", ptr)
print("address", address)
print("p2", p2)


p指针的地址 0x000000010000c388
ptr 0x000000010000c388
address 4314069216
p2 Optional(0x00000001012378e0)
```

###创建指针
```
var pointer = malloc(16)
pointer?.storeBytes(of: 10, as: Int.self)
pointer?.storeBytes(of: 20, toByteOffset: 8, as: Int.self)
print(pointer?.load(as: Int.self))
print(pointer?.load(fromByteOffset: 8, as: Int.self))
free(pointer)

// Optional(10)
// Optional(20)
```
```
var pointer = UnsafeMutableRawPointer.allocate(byteCount: 16, alignment: 1)
pointer.storeBytes(of: 10, as: Int.self)
pointer.storeBytes(of: 20, toByteOffset: 8, as: Int.self)
print(pointer.load(as: Int.self))
print(pointer.load(fromByteOffset: 8, as: Int.self))
pointer.deallocate()
```
```
class Person {
    var age: Int
    var name: String
    
    init(age: Int, name: String) {
       self.age = age
       self.name = name
    }
    
    deinit {
        print(name, "deinit")
    }
}

var pointer = UnsafeMutablePointer<Person>.allocate(capacity: 3)
pointer.initialize(to: Person(age: 10, name: "10"))
pointer.successor().initialize(to: Person(age: 20, name: "20"))
pointer.successor().successor().initialize(to: Person(age: 30, name: "30"))

pointer.deinitialize(count: 2)
pointer.deallocate()

// 10 deinit
// 20 deinit
// 一定要调用deinitialize 同时count要正确
```

###指针之间的转换

```
var ptr1 = UnsafeMutableRawPointer.allocate(byteCount: 16, alignment: 1)
var ptr2 = ptr1.assumingMemoryBound(to: Int.self)
var ptr3 = (ptr1+8).assumingMemoryBound(to: Float.self)

ptr2.pointee = 11
ptr3.pointee = 10

print(unsafeBitCast(ptr1, to: UnsafePointer<Int>.self).pointee) // 11
print(unsafeBitCast(ptr1 + 8, to: UnsafePointer<Float>.self).pointee) // 22.0

print(ptr1)
print(ptr2)
print(ptr3)

print(ptr2.pointee)
print(ptr3.pointee)


11
10.0
0x000000010130ad70
0x000000010130ad70
0x000000010130ad78
11
10.0
(lldb) x/2g 0x0000000100727ef0
0x100727ef0: 0x000000000000000b 0xb000000041200000
```

```
var age1: Int = 10
var age2 = unsafeBitCast(age1, to: Double.self)
print(age1)
print(age2)

10
5e-323
```

```
class Person { }

var p = Person()
var address = unsafeBitCast(p, to: UInt.self)
var pointer = UnsafeRawPointer(bitPattern: address)
print(pointer)
print(UnsafeRawPointer(&p))


Optional(0x000000010160bc90)
0x000000010000c340
(lldb) x/1g 0x000000010000c340
0x10000c340: 0x000000010160bc90
```

```
class Person { }

var p = Person()
let pointer = unsafeBitCast(p, to: UnsafeRawPointer.self)
print(UnsafeRawPointer(&p))
print(pointer)


0x000000010000c338
0x0000000101439470
(lldb) x/1g 0x000000010000c338
0x10000c338: 0x0000000101439470
```